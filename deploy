#! /bin/bash
PLATFORM=`uname`

function build_vim {
    # roll our own VIM
    case $PLATFORM in
        SunOS)
            sudo pkgin -y install mercurial
            sudo pkgin -y install build-essential
            sudo pkgin -y install cmake
            ;;
        Linux)
            sudo apt-get -y install libncurses5-dev python-dev mercurial
            sudo apt-get -y install cmake
            sudo apt-get -y remove vim vim-runtime gvim vim-tiny vim-common vim-gui-common
            ;;
    esac

    cd ~
    git clone https://github.com/vim/vim.git
    cd vim
    git checkout v8.0.0325
    case $PLATFORM in
        SunOS)
            ./configure --with-features=huge \
                --enable-rubyinterp \
                --enable-pythoninterp \
                --enable-cscope --prefix=/opt/local
            make VIMRUNTIMEDIR=/opt/local/share/vim/vim80
            sudo make install
            ;;
        Linux)
            ./configure --with-features=huge \
                --enable-rubyinterp \
                --enable-pythoninterp \
                --enable-perlinterp \
                --enable-cscope --prefix=/usr
            make VIMRUNTIMEDIR=/usr/share/vim/vim80
            sudo make install
            sudo update-alternatives --install /usr/bin/editor editor /usr/bin/vim 1
            sudo update-alternatives --set editor /usr/bin/vim
            sudo update-alternatives --install /usr/bin/vi vi /usr/bin/vim 1
            sudo update-alternatives --set vi /usr/bin/vim
            ;;
    esac
}

case $PLATFORM in
    Darwin)
        brew install cmake reattach-to-user-namespace
        ln -s $HOME/dotfiles/.darwin $HOME/.darwin
        git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
        touch .manta
        ~/.fzf/install
        git clone https://github.com/syl20bnr/spacemacs ~/.emacs.d
        ;;
    SunOS)
        sudo pkgin -y install p5-ack
        sudo pkgin -y install zsh
        sudo pkgin -y install tmux
        sudo usermod -s /opt/local/bin/zsh $USER
        ln -s $HOME/dotfiles/.sun $HOME/.sun
        build_vim
        ;;
    Linux)
        sudo apt-get -y install ack-grep
        sudo apt-get -y install zsh
        sudo chsh -s /usr/bin/zsh $USER
        sudo apt-get -y install curl
        ln -s $HOME/dotfiles/.linux $HOME/.linux
        build_vim
        ;;
esac

cd $HOME/dotfiles
git submodule update --init --recursive
cd .vim/bundle/YouCompleteMe
./install.sh

cd $HOME
if [ ! -d "$HOME/.config" ]; then
    mkdir "$HOME/.config"
fi
if [ -a "$HOME/.zshrc" ]; then
    mv .zshrc .zshrc.orig
fi
if [ -a "$HOME/.vimrc" ]; then
    mv .vimrc .vimrc.orig
fi
if [ -a "$HOME/.gitconfig" ]; then
    mv .gitconfig .gitconfig.orig
fi
touch .manta

git clone https://github.com/syl20bnr/spacemacs ~/.emacs.d
curl -L https://github.com/robbyrussell/oh-my-zsh/raw/master/tools/install.sh | sh

rmdir $HOME/.emacs.d/private/snippets
mkdir $HOME/bin
ln -s $HOME/dotfiles/.ackrc
ln -s $HOME/dotfiles/.default-difftool.sh $HOME/bin/default-difftool.sh
ln -s $HOME/dotfiles/.gitconfig
ln -s $HOME/dotfiles/.tmux.conf
ln -s $HOME/dotfiles/.vim
ln -s $HOME/dotfiles/.vimrc
ln -s $HOME/dotfiles/.zshrc
ln -s $HOME/dotfiles/angular-vim-snippets/UltiSnips $HOME/dotfiles/.vim/UltiSnipsAngular
ln -s $HOME/dotfiles/.config/powerline $HOME/.config/powerline
ln -s $HOME/dotfiles/.config/.spacemacs $HOME/.config/.spacemacs
ln -s $HOME/dotfiles/.emacs.d/private/snippets $HOME/.emacs.d/private/snippets

