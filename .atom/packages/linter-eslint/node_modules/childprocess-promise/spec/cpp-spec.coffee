describe 'CPPromise', ->
  CPPromise = require('..')
  cppromise = null

  getChild = (childPath) ->
    cppromise?.disconnect()
    cppromise = new CPPromise(childPath)

  it 'works', ->
    waitsForPromise ->
      failed = false
      failedAgain = false
      getChild(__dirname + '/fixtures/child.js')
      cppromise.request('ping').then (output) ->
        expect(output).toBe('pong')
        return cppromise.request('failing')
      .catch( (content) ->
        failed = true
        expect(content).toBe('Wow')
        return cppromise.request('throwing')
      ).catch( (content) ->
        failedAgain = true
        expect(content.message).toBe('throwing')
      ).then ->
        expect(failed).toBe(true)
        expect(failedAgain).toBe(true)
        expect(cppromise.target.connected).toBe(true)
        cppromise.disconnect()
        expect(cppromise.target.connected).toBe(false)
